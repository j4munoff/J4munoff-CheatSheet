# NMAP

La herramienta **nmap** es una de las mas potentes herramientas de escaneo de redes.

Se irán incorporando diferentes formas de uso a medida que se utilicen en la resolución de máquinas.

## Escaneo inicial, silencioso

El primer escaneo a un objetivo debe cubrir el máximo numero de puertos. Hay que ser cuidadoso en ser lo mas silencioso y rápido posible para que no tarde mucho el escaneo y para que no nos bloquee cualquier sistema de control tipo firewall o wap.

Este es el escaneo inicial que deberíamos lanzar:

```bash 
sudo nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 192.168.11.161 -oA allPorts
```
Donde:

* -p-: Todos los puertos, los 65535.
* --open: Se muestran solo los abiertos.
* -sS: REaliza un Simple Scan. Es silencioso ya que no confirma la comunicación.
--min-rate 5000: Es el tiempo mínimo que espera a enviar un paquete después de enviar el anterior.
-vvv: Triple verbose. Nos muestra en pantalla lo que descubre en el momento que lo descubre.
-n: Evita la resolución DNS. Nop es necesario en máquinas controladas y aumenta la velocidad.
-Pn: Evita el descubrimiento de host. Ya lo hemos nosotros.
-oA: Exporta los resultados en todos los formatos posibles. Creará 3 ficheros:
    * allPorts.xml: Formato xml compatible con el framework **metasploit**.
    * allPorts.nmap: Formato nmap, igual a lo que se ve en pantalla.
    * allPorts.gnmap: Formato **grepeable**. Permite jugar con expresiones regulares.


![](/.gitbook/assets/nmap01.png)

## Escaneo exhaustivo de varios puertos

Una vez identificados los puertos podemos lanzar un escaneo mas completo sobre dichos puertos.

```bash
sudo nmap -sC -sV -p22,80 192.168.11.161 -oN targeted
```

Que puede comprimirse en:

```bash
sudo nmap -sCV -p22,80 192.168.11.161 -oN targeted
```

Donde:

* -sC: Ejecuta un rango de scripts básicos de reconocimiento. 
* -sV: Intenta averiguar la versión del servicio que está corriendo.
* -p22,80: Solo se centra en estos puertos.
*-oN: Realiza el output en formato nmap al fichero targeted.

![](/.gitbook/assets/nmap02.png)

## Fuzzing Web

Si tenemos abiertos puertos Web, podemos realizar una búsqueda de subdirectorios sobre los 1000 nombres mas comunes.

```bash
sudo nmap --script http-enum -p80 192.168.11.161 -oN webScan
```

## Escaneo de vulnerabilidades

Si creemos que estamos ante un sistema que puede tener vulnerabilidades conocidas, (ejemplo, Windows 7 con puerto smb 445 abierto y sin firmar. Es candidato e EternalBlue), podemos intentar detectar vulnerabilidades. Es un script un poco mas agresivo.

```bash
sudo nmap --script "vuln and safe" -p 192.168.11.161 -oN vulnScan
```

## Formato grepeable

Si ejecutamos un script inicial puede darse la ocasión que nos devuelva muchos puertos abiertos. Esto es muy habitual en sistemas windows.

Para luego lanzar un script exhaustivo de dichos puertos podríamos perder una cantidad enorme de tiempo en escribirlos.

El creador de contenido [S4vitar](https://s4vitar.github.io/) programó una utilidad que ayuda en este aspecto.

La utilidad es una función llamada **extractPorts** que muestra por pantalla todos los puertos deparados por una ",", lo que permit un copiado fácil, a la par que nos guarda dicha cadena de puertos separados por coma en el portapapeles.


Tenemos que añadir en el fichero de configuración dela consola, en nuestro caso **.zshrz** la función **extractPorts**:

```bash
# Extract nmap information
function extractPorts(){
  ports="$(cat $1 | grep -oP '\d{1,5}/open' | awk '{print $1}' FS='/' | xargs | tr ' ' ',')"
  ip_address="$(cat $1 | grep -oP '\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}' | sort -u | head -n 1)"
  echo -e "\n[*] Extracting information...\n" > extractPorts.tmp
  echo -e "\t[*] IP Address: $ip_address"  >> extractPorts.tmp
  echo -e "\t[*] Open ports: $ports\n"  >> extractPorts.tmp
  echo $ports | tr -d '\n' | xclip -sel clip
  echo -e "[*] Ports copied to clipboard\n"  >> extractPorts.tmp
  cat extractPorts.tmp; rm extractPorts.tmp
}
```

También nos tenemos que instalar la utilidad **xclip** que permite copiar al portapapeles desde linea de comandos:

```bash
sudo apt install xclip
```

Ahora, después del escaneo inicial, podemos ejecutar dicha función para preparar el escaneo exhaustivo, indicándole el archivo de salida en formato grepeable.

![](/.gitbook/assets/nmap03.png)

